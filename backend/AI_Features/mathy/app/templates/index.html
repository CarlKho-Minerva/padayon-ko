<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholarship Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes typing {
            0% {
                width: 0
            }

            100% {
                width: 100%
            }
        }

        .typing-animation {
            display: inline-block;
            overflow: hidden;
            animation: typing 2s steps(40, end);
            white-space: nowrap;
            border-right: 2px solid #000;
        }

        .markdown p {
            margin-bottom: 0.5rem;
        }

        .markdown ul,
        .markdown ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .markdown code {
            background-color: #f0f0f0;
            padding: 0.1rem 0.3rem;
            border-radius: 0.2rem;
        }
    </style>
</head>

<body class="bg-blue-50 min-h-screen">
    <div class="container mx-auto p-4 h-screen flex flex-col md:flex-row gap-4">
        <!-- Chat Column -->
        <div class="w-full md:w-1/2 bg-white rounded-lg shadow-md flex flex-col h-full">
            <div class="p-4 bg-blue-600 text-white rounded-t-lg">
                <h2 class="text-xl font-semibold">Chat</h2>
            </div>
            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input id="message-input" type="text"
                        class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Type your message...">
                    <button id="send-button"
                        class="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Send</button>
                </div>
            </div>
        </div>

        <!-- Tools Column -->
        <div class="w-full md:w-1/2 space-y-4">
            <!-- Calculators -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button class="w-full p-4 bg-blue-600 text-white text-left focus:outline-none"
                    onclick="toggleContent('calculators')">
                    <h3 class="text-xl font-semibold">Calculators</h3>
                </button>
                <div id="calculators-content" class="p-4 hidden">
                    <div class="flex space-x-2 mb-4">
                        <button
                            class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Calculator
                            1</button>
                        <button
                            class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Calculator
                            2</button>
                    </div>
                    <div id="calculator-content" class="h-48 bg-gray-100 rounded-lg"></div>
                </div>
            </div>

            <!-- Code Interpreters -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button class="w-full p-4 bg-blue-600 text-white text-left focus:outline-none"
                    onclick="toggleContent('interpreters')">
                    <h3 class="text-xl font-semibold">Code Interpreters</h3>
                </button>
                <div id="interpreters-content" class="p-4 hidden">
                    <div class="flex space-x-2 mb-4">
                        <button
                            class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Python</button>
                        <button
                            class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500">Sage
                            Math</button>
                    </div>
                    <div id="interpreter-content" class="h-48 bg-gray-100 rounded-lg"></div>
                </div>
            </div>

            <!-- Sketchpad -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button class="w-full p-4 bg-blue-600 text-white text-left focus:outline-none"
                    onclick="toggleContent('sketchpad')">
                    <h3 class="text-xl font-semibold">Sketchpad</h3>
                </button>
                <div id="sketchpad-content" class="p-4 hidden">
                    <div id="sketchpad" class="h-48 bg-gray-100 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let chatId = null;
        let currentQuestionIndex = 0;
        let answers = [];

        async function getInitialQuestions() {
            const response = await fetch('/initial_questions');
            const data = await response.json();
            return data.questions;
        }

        async function askInitialQuestions() {
            const questions = await getInitialQuestions();
            await askNextQuestion(questions);
        }

        async function askNextQuestion(questions) {
            if (currentQuestionIndex < questions.length) {
                appendMessage('AI', questions[currentQuestionIndex]);
                currentQuestionIndex++;
            } else if (currentQuestionIndex === questions.length) {
                await startChat();
                currentQuestionIndex++; // Increment to move past the initial questions phase
            } else {
                // Handle the case where the chat has already started
                const message = messageInput.value.trim();
                if (message) {
                    appendMessage('You', message);
                    messageInput.value = '';
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            chat_id: chatId
                        }),
                    });
                    const data = await response.json();
                    appendMessage('AI', data.response);
                }
            }
        }

        async function startChat() {
            const response = await fetch('/start_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    interest: answers[0],
                    problem: answers[1],
                    level: answers[2]
                }),
            });
            const data = await response.json();
            chatId = data.chat_id;
            appendMessage('AI', data.response);
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                appendMessage('You', message);
                messageInput.value = '';
                console.log('Current Question Index:', currentQuestionIndex); // Debugging line

                if (currentQuestionIndex <= 3) {
                    answers.push(message);
                    const questions = await getInitialQuestions();
                    await askNextQuestion(questions);
                } else if (currentQuestionIndex >= 3) {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            chat_id: chatId
                        }),
                    });
                    const data = await response.json();
                    appendMessage('AI', data.response);
                    currentQuestionIndex++;
                }
            }
        }

        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = sender === 'You' ? 'bg-blue-100 p-3 rounded-lg' : 'bg-gray-100 p-3 rounded-lg';
            messageElement.innerHTML = `<strong class="font-semibold">${sender}:</strong> <span class="text-gray-700">${text}</span>`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function toggleContent(id) {
            const content = document.getElementById(`${id}-content`);
            content.classList.toggle('hidden');
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        askInitialQuestions();

        // Open the first toggle by default
        toggleContent('calculators');
    </script>
</body>

</html>